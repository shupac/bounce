<!DOCTYPE html>
<html>
<head>
  <title>Object Dance Party</title>
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <script src="lib/jquery.js"></script>
  <script src="src/dancer.js"></script>
  <script src="src/bouncyDancers.js"></script>
  <script src="src/peg.js"></script>
  <script src="src/pegArray.js"></script>
</head>
<body>

<div class="topbar">
  <span class="title">object dance party</span>
  Add dancers: <input class="numDancers" type="text" size="2" value="20"></input>
  <button type="button" class='addDancers'>Add Dancers</button>
  <a href="#" class="lineup">Lineup</a>
</div>
<div class="main"></div>
<script>
  var height = $('body').height();
  var width = $('body').width();
  $('.typeDancers').val('BouncyDancer');

  var showDancers = function() {
    for(var i = 0; i < window.dancers.length; i++) {
      $('body').append(window.dancers[i].$node);
    }
  };

  var explode = function(x, y) {
    x = x || width/2;
    y = y || height/2;
    for(var i = 0; i < window.dancers.length; i++) {
      window.dancers[i].randDir();
      window.dancers[i].setPosition(y, x);
      if(!window.dancers[i].moving) {
        window.dancers[i].startMoving();
      }
    }
  };

  var clickEvent = function() {
    var startX, startY, endX, endY;
    $('body').on('mousedown', '.peg', function() {
      startX = event.pageX;
      startY = event.pageY;
      var pegIndex = $(this).data('index');
      var peg = pegs.get(pegIndex);
      console.log(startX, startY);
      $(this).on('mousemove', function(click) {
        if(click.which === 1) {
          var displX = event.pageX - startX;
          var displY = event.pageY - startY;
          if(Math.abs(displX) > 5 || Math.abs(displY) > 5) {
            peg.setPosition(event.pageX, event.pageY);
          }
        }
      });
    });
    $('div').not($('div .peg')).on('mousedown', function(event){
      if(event.pageY > 32 && event.which === 1) {
          startX = event.pageX;
          startY = event.pageY;
        }
    });
    $('div').not($('div .peg')).on('mouseup', function(){
      if(event.pageY > 32 && event.which === 1) {
        endX = event.pageX;
        endY = event.pageY;
        if(Math.abs(startX - endX) > 5 || Math.abs(startY - endY) > 5) {
          var newPeg = pegs.add(startX, startY, endX, endY);
          $('body').append(newPeg);
        } else {
          explode(endX, endY);
        }
      }
    });

  };


  $(document).ready(function(){
    window.dancers = [];
    window.pegs = new PegArr();

    $('.addDancers').on('click', function(){
      for(var i = 0; i < $('.numDancers').val(); i++) {
        var dancer = new BouncyDancer(
          ($("body").height()-52) * Math.random()+32,
          ($("body").width()-20) * Math.random()
        );
        window.dancers.push(dancer);
      }
      showDancers();
    })

    $('.lineup').on('click', function() {
      var space = 5;
      var size = 20;
      for(var i = 0; i < window.dancers.length; i++) {
        var column = Math.floor(i/space);
        window.dancers[i].setPosition(32+ i % space * size, column * size);
        window.dancers[i].stopMoving();
      }
    });

    $('body').keydown(function(e){
      if(e.shiftKey) explode();
      if((e.metaKey || e.ctrlKey) && e.which === 90) {
        console.log(e.which);
        var lastPegNode = pegs.lastNode();
        if(lastPegNode) lastPegNode.remove();
      }
    });


    clickEvent();

  });
</script>

</body>
</html>
